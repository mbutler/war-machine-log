<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Artificer's Lab</title>
  <style>
    /* --- SUITE DESIGN SYSTEM --- */
    * { box-sizing: border-box; }
    body { margin: 0; padding: 1.5rem; font-family: system-ui, -apple-system, sans-serif; background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #000 100%); color: #e5e7eb; }
    h1 { margin: 0 0 0.3rem 0; font-size: 1.6rem; letter-spacing: -0.02em; }
    .tagline { font-size: 0.85rem; color: #94a3b8; margin-bottom: 1.2rem; }
    
    .layout-main { display: grid; grid-template-columns: 300px 1fr 320px; gap: 1rem; margin-top: 0.75rem; }
    @media (max-width: 1100px) { .layout-main { grid-template-columns: 1fr 1fr; } .panel-log { grid-column: span 2; } }
    @media (max-width: 768px) { .layout-main { grid-template-columns: 1fr; } .panel-log { grid-column: span 1; } }

    /* Cards */
    .card { border-radius: 0.75rem; border: 1px solid #1f2937; background: #0f172a; padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; height: fit-content; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid #1e293b; margin-bottom: 0.5rem; }
    .card-title { font-weight: 700; font-size: 1rem; color: #f8fafc; text-transform: uppercase; letter-spacing: 0.05em; }
    
    /* Inputs */
    label { display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 3px; }
    input[type="text"], input[type="number"], select {
      width: 100%; background: #020617; border: 1px solid #334155; color: #e2e8f0;
      padding: 6px 8px; border-radius: 4px; font-size: 0.9rem;
    }
    input:focus, select:focus { border-color: #6366f1; outline: none; }
    
    .row { display: flex; gap: 8px; }
    .row > div { flex: 1; }
    
    /* Stats */
    .stat-display { background: #020617; padding: 8px 12px; border-radius: 6px; border: 1px solid #334155; text-align: center; }
    .stat-val { font-size: 1.4rem; font-weight: 700; color: #fff; display: block; }
    .stat-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; }

    /* Visuals */
    .chance-wheel {
      width: 100%; background: #1e293b; border-radius: 6px; padding: 15px; 
      text-align: center; border: 1px solid #334155; margin-top: 10px;
    }
    .chance-val { font-size: 2rem; font-weight: 800; color: #a7f3d0; }
    .chance-fail { color: #fca5a5; }

    /* Buttons */
    .btn { width: 100%; padding: 10px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
    .btn-primary { background: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
    .btn-primary:hover { background: #4338ca; }
    .btn-sec { background: #334155; color: #cbd5e1; margin-top: 8px; font-size: 0.8rem; }

    /* Log */
    .log-container { background: #000; border: 1px solid #334155; border-radius: 8px; height: 500px; overflow-y: auto; padding: 10px; font-family: 'Courier New', monospace; font-size: 0.8rem; }
    .log-entry { margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px dashed #333; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-right: 5px; }
    .badge.magic { background: #4c1d95; color: #e9d5ff; }
    .badge.success { background: #064e3b; color: #a7f3d0; }
    .badge.fail { background: #450a0a; color: #fca5a5; }
  </style>
</head>
<body>

  <h1>The Artificer's Lab</h1>
  <p class="tagline">Manage libraries, research spells, and enchant items.</p>

  <div class="layout-main">

    <!-- 1. THE ARCANIST (Stats & Library) -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">The Caster</span>
      </div>
      
      <div class="row">
        <div style="flex:2">
          <label>Name</label>
          <input type="text" id="castName" value="Archmage Solon" class="save">
        </div>
        <div style="flex:1">
          <label>Level</label>
          <input type="number" id="castLvl" value="9" class="save">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Class</label>
          <select id="castClass" class="save">
            <option value="mu">Magic-User / Elf</option>
            <option value="cleric">Cleric / Druid</option>
          </select>
        </div>
        <div>
          <label>Int / Wis Score</label>
          <input type="number" id="castStat" value="16" class="save">
        </div>
      </div>

      <div style="margin-top:15px; border-top:1px solid #1e293b; padding-top:10px">
        <span class="card-title" style="font-size:0.8rem; display:block; margin-bottom:8px">Resources</span>
        
        <label>Gold (GP)</label>
        <input type="number" id="resGold" value="25000" class="save">
        
        <label style="margin-top:6px">Library Value (GP)</label>
        <input type="number" id="resLib" value="10000" class="save">
        <div style="font-size:0.7rem; color:#64748b; margin-top:3px">
          Library Bonus: <span id="libBonus">+0%</span> (Min 2,000gp)
        </div>
      </div>

      <button class="btn btn-sec" onclick="investLibrary()">Invest 1,000gp in Library</button>
    </div>

    <!-- 2. THE WORKBENCH (Calculation) -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Enchantment Workbench</span>
      </div>
      
      <div class="row" style="background:#334155; padding:8px; border-radius:6px; margin-bottom:10px">
         <div style="flex:1; text-align:center">
            <label style="margin:0; cursor:pointer">
               <input type="radio" name="mode" id="modeFormula" value="formula" onchange="updateCalculations()">
               Research Formula
            </label>
         </div>
         <div style="flex:1; text-align:center">
            <label style="margin:0; cursor:pointer">
               <input type="radio" name="mode" id="modeItem" value="item" checked onchange="updateCalculations()">
               Create Item
            </label>
         </div>
      </div>
      
      <div class="row">
        <div>
           <label>Item Type</label>
           <select id="itemType">
             <option value="scroll">Scroll (1 Wk/Lvl)</option>
             <option value="potion">Potion (1 Wk/Lvl)</option>
             <option value="wand">Wand/Staff/Rod</option>
             <option value="ring">Ring / Misc Item</option>
             <option value="weapon">Weapon / Armor</option>
             <option value="construct">Golem / Construct</option>
           </select>
        </div>
        <div>
           <label>Primary Spell Lvl</label>
           <input type="number" id="spellLvl" value="3">
        </div>
      </div>
      
      <div class="row" style="margin-top:8px">
        <div>
          <label>Material Cost (GP)</label>
          <input type="number" id="baseCost" value="1000">
        </div>
        <div style="display:flex; align-items:end">
           <label style="display:flex; align-items:center; cursor:pointer; color:#e2e8f0" id="lblFormula">
             <input type="checkbox" id="hasFormula" style="width:auto; margin-right:8px"> 
             Have Formula?
           </label>
        </div>
      </div>

      <!-- Calculations Display -->
      <div style="margin-top:15px; background:#1e293b; border-radius:6px; padding:10px; border:1px solid #334155">
         <div class="row">
           <div class="stat-display">
             <span class="stat-val" id="outCost">0</span>
             <span class="stat-label">Gold Cost</span>
           </div>
           <div class="stat-display">
             <span class="stat-val" id="outTime">0</span>
             <span class="stat-label">Weeks</span>
           </div>
         </div>
         
         <div class="chance-wheel">
           <div style="font-size:0.75rem; color:#94a3b8; text-transform:uppercase; margin-bottom:5px">Probability of Success</div>
           <span class="chance-val" id="outChance">0%</span>
           <div style="font-size:0.75rem; color:#64748b; margin-top:5px" id="chanceBreakdown">
             Base 15% + Lvl + Int - (2x Spell Lvl)
           </div>
           <div id="libWarning" style="color:#f87171; font-size:0.7rem; margin-top:4px; display:none">
              Library Inadequate! Need <span id="libReq">0</span>gp value.
           </div>
         </div>
      </div>

      <button class="btn btn-primary" style="margin-top:15px" id="btnCraft" onclick="craftItem()">Begin Research</button>
      <div id="errorMsg" style="color:#f87171; font-size:0.8rem; text-align:center; margin-top:5px; display:none"></div>
    </div>

    <!-- 3. GRIMOIRE (Log) -->
    <div class="card panel-log">
      <div class="card-header">
        <span class="card-title">Grimoire Log</span>
        <button style="background:none; border:none; color:#64748b; cursor:pointer; font-size:0.75rem" onclick="clearLog()">Clear</button>
      </div>
      <div class="log-container" id="log">
        <div style="color:#64748b; text-align:center; padding-top:60px">
          Experiments are recorded here...
        </div>
      </div>
    </div>

  </div>

  <script>
    // --- ENGINE --- //

    const getVal = (id) => parseInt(document.getElementById(id).value) || 0;
    const getChk = (id) => document.getElementById(id).checked;

    function updateCalculations() {
      const mode = document.getElementById('modeFormula').checked ? 'formula' : 'item';
      const type = document.getElementById('itemType').value;
      const spellLvl = getVal('spellLvl');
      let baseCost = getVal('baseCost');
      
      // UI Updates
      document.getElementById('lblFormula').style.display = (mode === 'item') ? 'flex' : 'none';
      document.getElementById('btnCraft').innerText = (mode === 'formula') ? 'Research Formula' : 'Create Item';

      let timeWeeks = 0;
      let calculatedCost = 0;
      
      // BECMI Rules (Rules Cyclopedia Chapter 16)
      // Costs are typically 1,000gp per week of effort.
      // Time depends on spell level.
      
      if (mode === 'formula') {
         // Formula Research: Cost = 1,000gp/wk. Time = 1 wk/spell level.
         timeWeeks = Math.max(1, spellLvl);
         calculatedCost = timeWeeks * 1000;
      } else {
         // Item Creation
         // Scroll: 1 wk/lvl. 500 gp/lvl
         // Potion: 1 wk. 500 gp.
         // Permanent: 1 wk/spell lvl. Cost = Material (Base) + 1,000gp * Lvl? 
         // RC p253: "Cost... is 1,000gp per spell level... plus actual cost of item."
         
         if(type === 'scroll') {
            timeWeeks = Math.max(1, spellLvl);
            calculatedCost = spellLvl * 500; 
         } else if (type === 'potion') {
            timeWeeks = 1; // Fixed 1 week
            calculatedCost = 500; // Fixed 500gp
         } else {
            // Permanent Items
            timeWeeks = Math.max(1, spellLvl);
            calculatedCost = baseCost + (spellLvl * 1000);
         }
      }

      // Chance Calculation (Rules Cyclopedia p. 253)
      // Chance = 15 + Lvl + Int - (2 * SpellLvl)
      const lvl = getVal('castLvl');
      const stat = getVal('castStat');
      
      let chance = 15 + lvl + stat - (2 * spellLvl);
      
      // Library Check (Min 2,000gp per spell level)
      const libVal = getVal('resLib');
      const libReq = spellLvl * 2000;
      const libOk = libVal >= libReq;
      
      if (!libOk) chance = 0;
      if (chance > 95) chance = 95; // Always 5% fail chance
      if (chance < 5) chance = 5;

      // Render
      document.getElementById('outCost').innerText = calculatedCost.toLocaleString();
      document.getElementById('outTime').innerText = timeWeeks;
      document.getElementById('outChance').innerText = chance + "%";
      
      const wheel = document.getElementById('outChance');
      if(chance < 50 || !libOk) { wheel.style.color = "#fca5a5"; }
      else { wheel.style.color = "#a7f3d0"; }
      
      // Library Warning
      const libWarn = document.getElementById('libWarning');
      if(!libOk) {
         libWarn.style.display = 'block';
         document.getElementById('libReq').innerText = libReq.toLocaleString();
      } else {
         libWarn.style.display = 'none';
      }
      
      // Breakdown tooltip
      document.getElementById('chanceBreakdown').innerText = 
        `Base(15) + Lvl(${lvl}) + Int(${stat}) - Diff(${spellLvl*2})`;

      return { calculatedCost, timeWeeks, chance, libOk, mode };
    }

    function investLibrary() {
      const gold = getVal('resGold');
      if(gold < 1000) {
        alert("Not enough gold!");
        return;
      }
      document.getElementById('resGold').value = gold - 1000;
      document.getElementById('resLib').value = getVal('resLib') + 1000;
      saveData();
      updateCalculations();
      logEntry("Library Expansion", "Invested 1,000gp into arcane archives.", "success");
    }

    function craftItem() {
      const calc = updateCalculations();
      const gold = getVal('resGold');
      
      const err = document.getElementById('errorMsg');
      err.style.display = 'none';

      // Validations
      if(gold < calc.calculatedCost) {
        err.innerText = "Insufficient Gold.";
        err.style.display = 'block';
        return;
      }
      
      if(!calc.libOk) {
        err.innerText = "Library Insufficient.";
        err.style.display = 'block';
        return;
      }
      
      if(calc.mode === 'item' && !getChk('hasFormula')) {
         err.innerText = "Cannot create item without researching Formula first.";
         err.style.display = 'block';
         return;
      }
      
      // Deduct resources
      document.getElementById('resGold').value = gold - calc.calculatedCost;
      
      // Roll
      const roll = Math.floor(Math.random() * 100) + 1;
      let outcome = "success";
      let title = (calc.mode === 'formula') ? "Formula Discovered" : "Item Created";
      let details = `Success! Used ${calc.timeWeeks} weeks and ${calc.calculatedCost}gp.`;
      
      // Logic
      if(roll > calc.chance) {
         outcome = "fail";
         title = "Research Failed";
         details = `The magic failed to coalesce. Time and gold wasted. (${roll} vs ${calc.chance}%)`;
         
         // RC p. 253: "If the roll fails, the money and time are lost."
         if (roll >= 95) {
             details += " CATASTROPHE! Lab damaged.";
             // Could implement lab value loss here
         }
      } else {
         // Success
         details += ` (Roll: ${roll})`;
      }

      logEntry(title, details, outcome);
      saveData();
    }

    function logEntry(title, text, type) {
      const id = Date.now();
      const badgeClass = type === 'success' ? 'success' : 'fail';
      const typeLabel = document.getElementById('itemType').value.toUpperCase();
      
      const html = `
        <div class="log-entry">
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
              <span class="badge magic">${typeLabel}</span>
              <span style="color:#64748b; font-size:0.7rem">${new Date().toLocaleTimeString()}</span>
           </div>
           <div style="margin-bottom:6px">
              <strong style="color:${type==='success'?'#a7f3d0':'#fca5a5'}">${title}</strong>
           </div>
           <div style="font-size:0.8rem; color:#94a3b8; line-height:1.4">
              ${text}
           </div>
        </div>
      `;

      const log = document.getElementById('log');
      if(log.innerText.includes("Experiments are")) log.innerHTML = "";
      log.innerHTML = html + log.innerHTML;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '<div style="color:#64748b; text-align:center; padding-top:60px">Experiments are recorded here...</div>';
    }

    // --- PERSISTENCE --- //
    function saveData() {
      const inputs = document.querySelectorAll('.save');
      const data = {};
      inputs.forEach(i => data[i.id] = i.value);
      localStorage.setItem('artificer_lab', JSON.stringify(data));
    }

    function loadData() {
      const raw = localStorage.getItem('artificer_lab');
      if(!raw) return;
      const data = JSON.parse(raw);
      const inputs = document.querySelectorAll('.save');
      inputs.forEach(i => {
        if(data[i.id] !== undefined) i.value = data[i.id];
      });
    }

    // Init
    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('change', () => { updateCalculations(); saveData(); });
      el.addEventListener('keyup', updateCalculations);
    });

    loadData();
    updateCalculations();

  </script>
</body>
</html>