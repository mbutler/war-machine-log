<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Royal Cartographer</title>
  <style>
    /* --- SUITE DESIGN SYSTEM --- */
    * { box-sizing: border-box; }
    body { margin: 0; padding: 1.5rem; font-family: system-ui, -apple-system, sans-serif; background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #000 100%); color: #e5e7eb; }
    h1 { margin: 0 0 0.3rem 0; font-size: 1.6rem; letter-spacing: -0.02em; }
    .tagline { font-size: 0.85rem; color: #94a3b8; margin-bottom: 1.2rem; }
    
    .layout-main { display: grid; grid-template-columns: 300px 1fr 300px; gap: 1rem; margin-top: 0.75rem; }
    @media (max-width: 1100px) { .layout-main { grid-template-columns: 1fr 1fr; } .panel-map { grid-column: span 2; order: -1; } }
    @media (max-width: 768px) { .layout-main { grid-template-columns: 1fr; } .panel-map { grid-column: span 1; } }

    /* Cards */
    .card { border-radius: 0.75rem; border: 1px solid #1f2937; background: #0f172a; padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; height: fit-content; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.5rem; border-bottom: 1px solid #1e293b; margin-bottom: 0.5rem; }
    .card-title { font-weight: 700; font-size: 1rem; color: #f8fafc; text-transform: uppercase; letter-spacing: 0.05em; }
    
    /* UI Elements */
    label { display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 3px; }
    select, input {
      width: 100%; background: #020617; border: 1px solid #334155; color: #e2e8f0;
      padding: 6px 8px; border-radius: 4px; font-size: 0.9rem;
    }
    
    /* Map Canvas */
    .map-container {
      background: #020617; border: 1px solid #334155; border-radius: 8px;
      overflow: hidden; position: relative; height: 500px; width: 100%;
      display: flex; justify-content: center; align-items: center;
    }
    canvas { background: #0f172a; cursor: crosshair; }

    /* Controls */
    .d-pad {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; width: 120px; margin: 0 auto;
    }
    .btn-dir {
      padding: 10px; background: #334155; border: none; border-radius: 4px; color: #fff; cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
    }
    .btn-dir:hover { background: #4f46e5; }
    .btn-dir:disabled { opacity: 0.3; cursor: not-allowed; }

    /* Weather Widget */
    .weather-box { background: #1e293b; padding: 10px; border-radius: 6px; border-left: 3px solid #60a5fa; }
    .weather-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px; }
    
    /* Stats */
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .stat-item { background: #1e293b; padding: 8px; border-radius: 4px; text-align: center; }
    .stat-lbl { font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; }
    .stat-val { font-size: 1rem; font-weight: bold; color: #fff; }

    /* Log */
    .log-container { background: #000; border: 1px solid #334155; border-radius: 8px; height: 300px; overflow-y: auto; padding: 10px; font-family: 'Courier New', monospace; font-size: 0.8rem; }
    .log-entry { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #333; }
    .badge { display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 0.65rem; font-weight: bold; margin-right: 5px; text-transform: uppercase; }
    
    .terrain-clear { color: #86efac; }
    .terrain-woods { color: #166534; font-weight: bold; }
    .terrain-hills { color: #d4d4d8; }
    .terrain-mountain { color: #71717a; font-weight: bold; }
    .terrain-swamp { color: #10b981; }
    .terrain-desert { color: #fdba74; }
    .terrain-water { color: #3b82f6; }
    
    .btn-primary { width:100%; padding:10px; background:#4f46e5; color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer; }
    .btn-primary:hover { background:#4338ca; }
    .btn-sec { width:100%; padding:8px; background:#334155; color:#e2e8f0; border:none; border-radius:6px; cursor:pointer; margin-top:8px; }
    
    .btn-sm { font-size: 0.75rem; padding: 4px 8px; background: #334155; border: none; border-radius: 4px; color: #e2e8f0; cursor: pointer; position: absolute; bottom: 10px; right: 10px; z-index: 10; }
    .btn-sm:hover { background: #475569; }
  </style>
</head>
<body>

  <h1>The Royal Cartographer</h1>
  <p class="tagline">BECMI Wilderness Generation (Expert Set) & Weather.</p>

  <div class="layout-main">

    <!-- CONTROLS -->
    <div class="card">
      <div class="card-header"><span class="card-title">Quartermaster</span></div>
      
      <div class="row">
        <div><label>Party Size</label><input type="number" id="partySize" value="6" min="1"></div>
        <div><label>Rations</label><input type="number" id="rations" value="42" min="0"></div>
      </div>
      
      <div style="background:#1e293b; padding:8px; border-radius:4px; margin-top:10px; font-size:0.8rem; text-align:center">
         <span style="color:#94a3b8">Time:</span> <span id="dayCount" style="font-weight:bold; color:#fff">0 days, 12/12 MP</span>
      </div>

      <div style="margin-top:20px; border-top:1px solid #334155; padding-top:15px">
        <div class="card-title" style="font-size:0.8rem; margin-bottom:10px; text-align:center">Travel</div>
        
        <div class="d-pad">
           <button class="btn-dir" onclick="move(0)" title="North West">↖</button>
           <button class="btn-dir" onclick="move(1)" title="North">↑</button>
           <button class="btn-dir" onclick="move(2)" title="North East">↗</button>
           <button class="btn-dir" onclick="move(3)" title="South West">↙</button>
           <button class="btn-dir" onclick="move(4)" title="South">↓</button>
           <button class="btn-dir" onclick="move(5)" title="South East">↘</button>
        </div>
        <div style="text-align:center; font-size:0.7rem; color:#64748b; margin-top:5px">Arrow = Travel to Hex</div>
      </div>
      
      <button class="btn-sec" onclick="forage()">Hunt / Forage (1 Day)</button>

      <div style="margin-top:auto">
        <hr style="border:0; border-top:1px solid #334155; margin:15px 0;">
        <label>Generator Settings</label>
        <select id="startTerrain" style="margin-bottom:5px">
          <option value="clear">Start: Clear</option>
          <option value="woods">Start: Woods</option>
          <option value="mountain">Start: Mountain</option>
          <option value="city">Start: City</option>
        </select>
        <select id="climate">
          <option value="normal">Climate: Temperate</option>
          <option value="cold">Climate: Cold</option>
          <option value="tropic">Climate: Tropical</option>
          <option value="desert">Climate: Arid</option>
        </select>
        <button class="btn-primary" onclick="resetMap()" style="margin-top:10px">New Map</button>
      </div>
    </div>

    <!-- MAP -->
    <div class="card panel-map" style="padding:0; border:none; background:transparent;">
      <div class="map-container">
        <canvas id="mapCanvas" width="600" height="500"></canvas>
        <div style="position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:4px; color:#fff; font-size:0.8rem">
           Pos: <span id="coords">0, 0</span>
        </div>
        <button class="btn-sm" onclick="recenterMap()">Recenter View</button>
      </div>
    </div>

    <!-- DETAILS -->
    <div class="card">
      <div class="card-header"><span class="card-title">Survey Report</span></div>
      
      <!-- Weather -->
      <div class="weather-box">
        <div style="color:#93c5fd; font-weight:bold; font-size:0.8rem; margin-bottom:5px; text-transform:uppercase">Daily Weather</div>
        <div class="weather-row">
           <span>Temp:</span> <span id="wTemp" style="color:#fff">--</span>
        </div>
        <div class="weather-row">
           <span>Wind:</span> <span id="wWind" style="color:#fff">--</span>
        </div>
        <div class="weather-row">
           <span>Precip:</span> <span id="wRain" style="color:#fff">--</span>
        </div>
      </div>

      <!-- Current Hex Info -->
      <div style="margin-top:15px">
         <div class="stat-grid">
           <div class="stat-item">
             <div class="stat-lbl">Terrain</div>
             <div class="stat-val" id="currTerrain" style="color:#86efac">--</div>
           </div>
           <div class="stat-item">
             <div class="stat-lbl">Travel Cost</div>
             <div class="stat-val" id="currCost">1 Day</div>
           </div>
         </div>
      </div>

      <!-- Features / Dominion -->
      <div style="margin-top:15px; padding:10px; background:#1e293b; border-radius:6px; font-size:0.8rem">
         <div style="color:#94a3b8; text-transform:uppercase; font-size:0.7rem; margin-bottom:5px">Dominion Resources</div>
         <div id="resList" style="line-height:1.5">
           No resources surveyed.
         </div>
         <div style="font-size:0.7rem; color:#64748b; margin-top:8px; border-top:1px dashed #334155; padding-top:5px">
           <i>Note: Resources add +1 gp/family to income if settled.</i>
         </div>
      </div>

      <div class="log-container" id="log" style="height:250px; margin-top:15px">
         <div style="color:#64748b; text-align:center; padding-top:20px">Survey Log...</div>
      </div>
    </div>

  </div>

  <script>
    // --- CONSTANTS ---
    // BECMI Movement Points per terrain (Expert Set p. 15)
    const TERRAIN = {
      'clear': { color: '#86efac', name: 'Clear', mpCost: 1, forage: 1, tables: {clear:12, woods:16, river:17, swamp:18, hills:19, mountain:20}, lost: 1, encounter: 1 },
      'woods': { color: '#15803d', name: 'Woods', cost: 1.5, mpCost: 2, forage: 3, tables: {clear:5, woods:14, river:15, swamp:16, hills:17, mountain:20}, lost: 2, encounter: 2 },
      'hills': { color: '#a1a1aa', name: 'Hills', cost: 1.5, mpCost: 2, forage: 2, tables: {clear:4, woods:7, river:8, swamp:9, hills:17, mountain:20}, lost: 2, encounter: 2 },
      'mountain': { color: '#52525b', name: 'Mountain', cost: 2, mpCost: 3, forage: 1, tables: {clear:3, woods:6, river:8, hills:14, mountain:20}, lost: 3, encounter: 3 },
      'swamp': { color: '#047857', name: 'Swamp', cost: 2, mpCost: 3, forage: 2, tables: {clear:3, woods:6, river:10, swamp:18, hills:19, mountain:20}, lost: 3, encounter: 3 },
      'desert': { color: '#fdba74', name: 'Desert', cost: 2, mpCost: 3, forage: 0, tables: {clear:4, desert:18, hills:19, mountain:20}, lost: 3, encounter: 2 },
      'city': { color: '#fcd34d', name: 'Settlement', cost: 1, mpCost: 1, forage: 6, tables: {clear:12, woods:16, river:17, swamp:18, hills:19, mountain:20}, lost: 0, encounter: 1 },
      'river': { color: '#3b82f6', name: 'River', cost: 1, mpCost: 1, forage: 3, tables: {clear:12, woods:16, river:20}, lost: 0, encounter: 2 },
      'ocean': { color: '#1e3a8a', name: 'Ocean', cost: 1, mpCost: 2, forage: 3, tables: {ocean:20}, lost: 3, encounter: 2 }
    };

    // BECMI Movement Rates (MP per day) - Expert Set p. 14
    const MOVEMENT_RATES = {
      'Fighter': 12,
      'Cleric': 12,
      'Thief': 12,
      'MagicUser': 12,
      'Elf': 12,
      'Dwarf': 12,
      'Halfling': 12,
      'Normal': 12  // For NPCs
    };

    // BECMI Wilderness Encounter Tables (Expert Set p. 44-47)
    const ENCOUNTER_TABLES = {
      // Level 1 Encounters (Clear/Open Terrain)
      level1: {
        'clear': [
          { name: 'Bandits', qty: '2-8' },
          { name: 'Berserkers', qty: '2-8' },
          { name: 'Brigands', qty: '2-8' },
          { name: 'Dwarves', qty: '2-8' },
          { name: 'Elves', qty: '2-8' },
          { name: 'Gnolls', qty: '2-8' },
          { name: 'Goblins', qty: '2-12' },
          { name: 'Halflings', qty: '2-12' },
          { name: 'Hobgoblins', qty: '2-12' },
          { name: 'Kobolds', qty: '4-16' },
          { name: 'Orcs', qty: '2-8' },
          { name: 'Ogres', qty: '1-3' }
        ],
        'woods': [
          { name: 'Bandits', qty: '2-8' },
          { name: 'Berserkers', qty: '2-8' },
          { name: 'Brigands', qty: '2-8' },
          { name: 'Dwarves', qty: '2-8' },
          { name: 'Elves', qty: '2-8' },
          { name: 'Gnolls', qty: '2-8' },
          { name: 'Goblins', qty: '2-12' },
          { name: 'Halflings', qty: '2-12' },
          { name: 'Hobgoblins', qty: '2-12' },
          { name: 'Kobolds', qty: '4-16' },
          { name: 'Orcs', qty: '2-8' },
          { name: 'Ogres', qty: '1-3' }
        ]
      },

      // Level 2 Encounters (Woods/Hills)
      level2: {
        'woods': [
          { name: 'Bugbears', qty: '2-8' },
          { name: 'Centaurs', qty: '1-6' },
          { name: 'Dryads', qty: '1-4' },
          { name: 'Giants (Hill)', qty: '1-4' },
          { name: 'Gnolls', qty: '3-12' },
          { name: 'Goblins', qty: '4-16' },
          { name: 'Hobgoblins', qty: '2-12' },
          { name: 'Lycanthropes', qty: '1-4' },
          { name: 'Nixies', qty: '2-8' },
          { name: 'Ogres', qty: '1-3' },
          { name: 'Orcs', qty: '3-18' },
          { name: 'Sprites', qty: '4-16' }
        ],
        'hills': [
          { name: 'Bugbears', qty: '2-8' },
          { name: 'Centaurs', qty: '1-6' },
          { name: 'Dryads', qty: '1-4' },
          { name: 'Giants (Hill)', qty: '1-4' },
          { name: 'Gnolls', qty: '3-12' },
          { name: 'Goblins', qty: '4-16' },
          { name: 'Hobgoblins', qty: '2-12' },
          { name: 'Lycanthropes', qty: '1-4' },
          { name: 'Nixies', qty: '2-8' },
          { name: 'Ogres', qty: '1-3' },
          { name: 'Orcs', qty: '3-18' },
          { name: 'Sprites', qty: '4-16' }
        ]
      },

      // Level 3 Encounters (Mountains/Swamps)
      level3: {
        'mountain': [
          { name: 'Basilisks', qty: '1-2' },
          { name: 'Chimera', qty: '1' },
          { name: 'Dragons (young)', qty: '1' },
          { name: 'Giants (Stone)', qty: '1-2' },
          { name: 'Gorgons', qty: '1-2' },
          { name: 'Griffons', qty: '1-4' },
          { name: 'Harpies', qty: '2-8' },
          { name: 'Hydras', qty: '1' },
          { name: 'Lycanthropes', qty: '2-8' },
          { name: 'Manticores', qty: '1-2' },
          { name: 'Ogres', qty: '2-8' },
          { name: 'Trolls', qty: '1-3' }
        ],
        'swamp': [
          { name: 'Basilisks', qty: '1-2' },
          { name: 'Chimera', qty: '1' },
          { name: 'Dragons (young)', qty: '1' },
          { name: 'Giants (Stone)', qty: '1-2' },
          { name: 'Gorgons', qty: '1-2' },
          { name: 'Griffons', qty: '1-4' },
          { name: 'Harpies', qty: '2-8' },
          { name: 'Hydras', qty: '1' },
          { name: 'Lycanthropes', qty: '2-8' },
          { name: 'Manticores', qty: '1-2' },
          { name: 'Ogres', qty: '2-8' },
          { name: 'Trolls', qty: '1-3' }
        ]
      },

      // Special Encounter Tables
      castle: [
        { name: 'Bandits', qty: '10-40' },
        { name: 'Brigands', qty: '5-20' },
        { name: 'Orcs', qty: '20-80' },
        { name: 'Goblins', qty: '30-120' },
        { name: 'Hobgoblins', qty: '15-60' },
        { name: 'Ogres', qty: '2-8' },
        { name: 'Giants (Hill)', qty: '1-4' },
        { name: 'Trolls', qty: '1-3' },
        { name: 'Dragons (young)', qty: '1' }
      ],

      ruin: [
        { name: 'Ghouls', qty: '3-12' },
        { name: 'Skeletons', qty: '10-40' },
        { name: 'Zombies', qty: '8-32' },
        { name: 'Wights', qty: '1-4' },
        { name: 'Wraiths', qty: '1-3' },
        { name: 'Mummies', qty: '1-2' },
        { name: 'Basilisks', qty: '1' },
        { name: 'Gorgons', qty: '1' },
        { name: 'Lycanthropes', qty: '1-3' }
      ],

      lair: [
        { name: 'Orcs', qty: '10-40' },
        { name: 'Goblins', qty: '20-80' },
        { name: 'Hobgoblins', qty: '8-32' },
        { name: 'Gnoll', qty: '5-20' },
        { name: 'Bugbears', qty: '3-12' },
        { name: 'Ogres', qty: '2-8' },
        { name: 'Giants (Hill)', qty: '1-3' },
        { name: 'Trolls', qty: '1-2' },
        { name: 'Dragons (young)', qty: '1' }
      ]
    };

    const CLASSES = ["Fighter", "Cleric", "Magic-User", "Thief", "Dwarf", "Elf"];
    const ALIGNMENTS = ["Lawful", "Neutral", "Chaotic"];

    // HEX MATH (FLAT TOP / ODD-Q)
    const HEX_SIZE = 25; 
    const HEX_WIDTH = 2 * HEX_SIZE; 
    const HEX_HEIGHT = Math.sqrt(3) * HEX_SIZE;

    const DIRS = [
      [{q:-1, r:-1}, {q:0,  r:-1}, {q:1,  r:-1}, {q:-1, r:0}, {q:0,  r:1}, {q:1,  r:0}], 
      [{q:-1, r:0}, {q:0,  r:-1}, {q:1,  r:0}, {q:-1, r:1}, {q:0,  r:1}, {q:1,  r:1}]
    ];

    // --- STATE ---
    let map = {};
    let currentPos = { q: 0, r: 0 };
    let cameraOffset = { x: 0, y: 0 };
    let canvas, ctx;
    let days = 0;
    let movementPoints = 0; // Current MP remaining today
    let maxMovementPoints = 0; // Total MP available per day

    function init() {
      canvas = document.getElementById('mapCanvas');
      ctx = canvas.getContext('2d');
      cameraOffset = { x: canvas.width / 2, y: canvas.height / 2 };
      resetMap();
    }

    function resetMap() {
      map = {};
      currentPos = { q: 0, r: 0 };
      days = 0;
      movementPoints = calculatePartyMovementPoints();
      maxMovementPoints = movementPoints;
      cameraOffset = { x: canvas.width / 2, y: canvas.height / 2 };

      const start = document.getElementById('startTerrain').value;
      map["0,0"] = { type: start, visited: true, resources: [], feature: "Start", details: "Safe Haven" };

      document.getElementById('dayCount').innerText = '0 days';
      document.getElementById('rations').value = document.getElementById('partySize').value * 7;

      drawMap();
      updateInfo();
      generateWeather();
    }

    function calculatePartyMovementPoints() {
      // BECMI movement is based on the slowest party member
      // For simplicity, we'll use the standard rate (12 MP/day) since all classes have similar rates
      // In full BECMI, you'd need to know each character's class and equipment load
      return 12; // Standard movement rate
    }
    
    function recenterMap() {
      const pixelPos = getPixelPos(currentPos.q, currentPos.r);
      cameraOffset.x = (canvas.width / 2) - pixelPos.x;
      cameraOffset.y = (canvas.height / 2) - pixelPos.y;
      drawMap();
    }

    // --- RESOURCES ---
    function consumeMovementPoints(mpCost) {
      movementPoints -= mpCost;
      if (movementPoints <= 0) {
        // Day ends, reset MP and consume rations
        movementPoints = maxMovementPoints;
        consumeDailySupplies();
      }
    }

    function consumeDailySupplies() {
      const pSize = parseInt(document.getElementById('partySize').value);
      let rations = parseInt(document.getElementById('rations').value);

      const needed = pSize; // 1 ration per person per day
      rations -= needed;

      days += 1;
      document.getElementById('dayCount').innerText = `${days} days, ${movementPoints}/${maxMovementPoints} MP`;

      if(rations < 0) {
        rations = 0;
        logEntry(map[`${currentPos.q},${currentPos.r}`], currentPos, "STARVATION! Party takes damage.", "");
      }
      document.getElementById('rations').value = rations;
    }

    function forage() {
      const key = `${currentPos.q},${currentPos.r}`;
      const terrain = TERRAIN[map[key].type];

      consumeDailySupplies(); // Foraging takes a full day

      const roll = Math.floor(Math.random() * 6) + 1;
      if(roll <= terrain.forage) {
         const found = Math.floor(Math.random() * 6) + 1;
         let currentRations = parseInt(document.getElementById('rations').value);
         currentRations += found;
         document.getElementById('rations').value = currentRations;
         logEntry(map[key], currentPos, "", `Foraging Successful! Found ${found} rations.`);
      } else {
         logEntry(map[key], currentPos, "", "Foraging Failed. Found nothing.");
      }
      generateWeather();
    }

    // --- GENERATION ---
    function getTerrainFromTable(prevType) {
      if(!TERRAIN[prevType].tables) return prevType;
      const table = TERRAIN[prevType].tables;
      const roll = Math.floor(Math.random() * 20) + 1;
      for (const [type, threshold] of Object.entries(table)) {
        if (roll <= threshold) return type;
      }
      return prevType;
    }

    function generateHex(q, r, fromType) {
      const key = `${q},${r}`;
      if (map[key]) return map[key]; 

      const newType = getTerrainFromTable(fromType);
      
      // 1. Resources
      const resources = [];
      if(Math.random() < 0.2) resources.push("Animal");
      if(Math.random() < 0.2) resources.push("Vegetable");
      if(Math.random() < 0.1) resources.push("Mineral");
      
      // 2. Features & Details (Stronghold Generator)
      let feature = null;
      let details = "";
      
      // BECMI Probabilities (X59)
      const fRoll = Math.random();
      if(fRoll < 0.02) { // Castle
         feature = "Castle";
         const ownerLvl = Math.floor(Math.random() * 6) + 9; // 9-14
         const ownerClass = CLASSES[Math.floor(Math.random() * CLASSES.length)];
         const align = ALIGNMENTS[Math.floor(Math.random() * 3)];
         const troops = (Math.floor(Math.random() * 4) + 1) * 10;
         details = `${align} ${ownerClass} (Lvl ${ownerLvl}). Garrison: ${troops} troops.`;
      } else if (fRoll < 0.05) { // Ruins
         feature = "Ruins";
         details = "Ancient crumbling walls. Dungeon entrance?";
      } else if (fRoll < 0.15) { // Lair
         feature = "Lair";
         const encounter = generateBECMIEncounter({type: newType, feature: "Lair"});
         if (encounter) {
            details = encounter.replace("ENCOUNTER: ", "Lair of ");
         } else {
            details = "Empty lair.";
         }
      } else if (fRoll < 0.16) { // Settlement
         feature = "Town";
         details = "Small border settlement. Market available.";
      }

      map[key] = { type: newType, resources, feature, details, visited: true };
      return map[key];
    }

    function move(dirIndex) {
      // 1. Calculate "To" Hex (to see cost)
      const isOdd = Math.abs(currentPos.q) % 2 === 1;
      const delta = DIRS[isOdd ? 1 : 0][dirIndex];
      const nextQ = currentPos.q + delta.q;
      const nextR = currentPos.r + delta.r;
      
      const currKey = `${currentPos.q},${currentPos.r}`;
      const fromType = map[currKey].type;
      
      // Generate destination to check costs
      const nextHex = generateHex(nextQ, nextR, fromType);
      const nextData = TERRAIN[nextHex.type];

      // 2. Check Lost (Based on CURRENT terrain)
      // EXCEPTION: Rivers are safe landmarks
      const currData = TERRAIN[fromType];
      let actualDir = dirIndex;
      let lostMsg = "";
      let lostChance = currData.lost;
      if(fromType === 'river') lostChance = 0; // Safe
      
      if (Math.floor(Math.random() * 6) + 1 <= lostChance) {
         const drift = Math.floor(Math.random() * 6);
         if (drift !== dirIndex) {
            actualDir = drift;
            lostMsg = "LOST! Drifting...";
            const driftDelta = DIRS[isOdd ? 1 : 0][actualDir];
            const driftQ = currentPos.q + driftDelta.q;
            const driftR = currentPos.r + driftDelta.r;
            generateHex(driftQ, driftR, fromType);
            currentPos.q = driftQ;
            currentPos.r = driftR;
         } else {
            currentPos.q = nextQ;
            currentPos.r = nextR;
         }
      } else {
         currentPos.q = nextQ;
         currentPos.r = nextR;
      }

      // 3. Consume Movement Points
      const finalHex = map[`${currentPos.q},${currentPos.r}`];
      const finalData = TERRAIN[finalHex.type];
      consumeMovementPoints(finalData.mpCost);

      // 4. Updates
      const p = getPixelPos(currentPos.q, currentPos.r);
      const screenX = p.x + cameraOffset.x;
      const screenY = p.y + cameraOffset.y;
      const margin = 50;
      
      if(screenX < margin || screenX > canvas.width - margin || screenY < margin || screenY > canvas.height - margin) {
         recenterMap();
      } else {
         drawMap();
      }
      
      updateInfo();
      generateWeather();
      
      // 5. Encounter (BECMI Rules)
      let encounterMsg = "";
      if (Math.floor(Math.random() * 6) + 1 <= finalData.encounter) {
         encounterMsg = generateBECMIEncounter(finalHex);
      }

      logEntry(finalHex, currentPos, lostMsg, encounterMsg);
    }

    // --- WEATHER ---
    function generateWeather() {
      const climate = document.getElementById('climate').value;
      let tempRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
      if(climate === 'cold') tempRoll -= 3;
      if(climate === 'tropic') tempRoll += 3;
      
      let tempStr = "Moderate";
      if(tempRoll <= 4) tempStr = "Cold/Freezing";
      else if(tempRoll <= 6) tempStr = "Cool";
      else if(tempRoll >= 10) tempStr = "Hot";
      else if(tempRoll >= 12) tempStr = "Scorching";

      const windRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
      let windStr = "Breeze";
      if(windRoll <= 3) windStr = "Dead Calm";
      else if(windRoll >= 10) windStr = "Strong Winds";
      else if(windRoll >= 12) windStr = "Gale/Storm";

      const rainRoll = Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + 2;
      let rainStr = "None";
      if(rainRoll >= 10) rainStr = (tempStr.includes('Cold')) ? "Snow" : "Rain";
      if(rainRoll === 12) rainStr = "Heavy Storm";

      document.getElementById('wTemp').innerText = tempStr;
      document.getElementById('wWind').innerText = windStr;
      document.getElementById('wRain').innerText = rainStr;
    }

    // --- DRAWING ---
    function getPixelPos(q, r) {
      // ODD-Q Conversion
      const x = HEX_SIZE * 1.5 * q;
      const y = HEX_SIZE * Math.sqrt(3) * (r + 0.5 * (Math.abs(q)%2));
      return { x, y };
    }

    function drawHex(x, y, color, isCurrent, q, r) {
      ctx.beginPath();
      for (let i = 0; i < 6; i++) {
        const angle = (2 * Math.PI / 6) * i;
        const x_i = x + HEX_SIZE * Math.cos(angle);
        const y_i = y + HEX_SIZE * Math.sin(angle);
        if (i === 0) ctx.moveTo(x_i, y_i);
        else ctx.lineTo(x_i, y_i);
      }
      ctx.closePath();
      ctx.fillStyle = color;
      ctx.fill();
      ctx.lineWidth = 1;
      ctx.strokeStyle = "#1e293b";
      ctx.stroke();
      
      // Coords
      ctx.fillStyle = "rgba(0,0,0,0.3)";
      ctx.font = "10px monospace";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(`${q},${r}`, x, y);
    }

    function drawPlayer(x, y) {
      ctx.beginPath();
      ctx.arc(x, y, 8, 0, 2*Math.PI);
      ctx.fillStyle = "#ef4444";
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "#fff";
      ctx.stroke();
    }

    function drawMap() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      for (const key in map) {
        const [q, r] = key.split(',').map(Number);
        const terrain = map[key];
        const color = TERRAIN[terrain.type].color;
        
        const pos = getPixelPos(q, r);
        const x = pos.x + cameraOffset.x;
        const y = pos.y + cameraOffset.y;
        
        if(x > -50 && x < canvas.width + 50 && y > -50 && y < canvas.height + 50) {
           drawHex(x, y, color, false, q, r);
           if(terrain.feature) {
              ctx.beginPath();
              ctx.arc(x, y + 10, 3, 0, 2*Math.PI);
              ctx.fillStyle = "#fff";
              ctx.fill();
           }
        }
      }
      
      const pPos = getPixelPos(currentPos.q, currentPos.r);
      drawPlayer(pPos.x + cameraOffset.x, pPos.y + cameraOffset.y);
    }

    function updateInfo() {
      const key = `${currentPos.q},${currentPos.r}`;
      const hex = map[key];
      const data = TERRAIN[hex.type];
      document.getElementById('coords').innerText = `${currentPos.q}, ${currentPos.r}`;
      const terEl = document.getElementById('currTerrain');
      terEl.innerText = data.name;
      terEl.style.color = data.color;
      document.getElementById('currCost').innerText = data.mpCost + " MP";
      
      const resDiv = document.getElementById('resList');
      let html = "";
      
      if(hex.feature) {
         html += `<div style="color:#fbbf24; font-weight:bold; margin-bottom:4px">${hex.feature}</div>`;
         if(hex.details) html += `<div style="margin-bottom:8px; font-size:0.75rem; color:#e2e8f0">${hex.details}</div>`;
      } else {
         html += `<div style="color:#64748b; margin-bottom:4px">Wilderness</div>`;
      }
      
      if(hex.resources.length > 0) {
         hex.resources.forEach(r => { html += `<div>• ${r} Resource</div>`; });
      } else {
         html += `<div>No resources.</div>`;
      }
      resDiv.innerHTML = html;
    }

    function generateBECMIEncounter(hex) {
      // Determine encounter level (simplified - could be based on dungeon level or party level)
      const encounterLevel = Math.min(3, Math.max(1, Math.floor(days / 10) + 1)); // Gets harder over time
      const tableKey = `level${encounterLevel}`;

      let encounterTable;

      // Use special tables for features
      if (hex.feature === 'Castle') {
        encounterTable = ENCOUNTER_TABLES.castle;
      } else if (hex.feature === 'Ruins') {
        encounterTable = ENCOUNTER_TABLES.ruin;
      } else if (hex.feature === 'Lair') {
        encounterTable = ENCOUNTER_TABLES.lair;
      } else {
        // Use terrain-based table
        encounterTable = ENCOUNTER_TABLES[tableKey][hex.type] || ENCOUNTER_TABLES[tableKey]['clear'];
      }

      if (!encounterTable) return "";

      const encounter = encounterTable[Math.floor(Math.random() * encounterTable.length)];
      const qty = rollEncounterQuantity(encounter.qty);

      return `ENCOUNTER: ${qty} ${encounter.name}`;
    }

    function rollEncounterQuantity(qtyRange) {
      // Parse ranges like "2-8" or "1-3"
      const [min, max] = qtyRange.split('-').map(n => parseInt(n));
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function logEntry(hex, pos, lostMsg, encounterMsg) {
      const log = document.getElementById('log');
      const data = TERRAIN[hex.type];
      let msg = `Travelled to ${data.name}.`;
      if(hex.feature) msg += ` FOUND ${hex.feature.toUpperCase()}!`;
      
      let extraHtml = "";
      if(lostMsg) extraHtml += `<div style="color:#f87171; font-weight:bold; font-size:0.7rem">${lostMsg}</div>`;
      if(encounterMsg) extraHtml += `<div style="color:#fca5a5; font-weight:bold; font-size:0.7rem; margin-top:2px">${encounterMsg}</div>`;

      const html = `
        <div class="log-entry">
           <span style="color:#64748b; font-size:0.7rem">Day ${days.toFixed(1)} [${pos.q},${pos.r}]</span>
           <span style="color:${data.color}; font-weight:bold">${msg}</span>
           ${extraHtml}
        </div>
      `;
      log.innerHTML = html + log.innerHTML;
    }

    // Init
    init();
  </script>
</body>
</html>